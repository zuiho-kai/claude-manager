<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>CCM</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- Top: Quick input (always visible, like article's "随时派活") -->
    <div class="input-bar">
        <div class="input-row">
            <textarea id="quickInput" rows="1" placeholder="Tell Claude what to do..." oninput="autoGrow(this)"></textarea>
            <button class="mic-btn" id="micBtn" onclick="toggleVoice(this)" title="Voice input">&#127908;</button>
            <button class="send-btn" onclick="quickSend()" title="Send task">&#10148;</button>
        </div>
        <div class="input-meta">
            <span id="connDot" class="conn-dot"></span>
            <span id="connText" class="conn-text">connecting</span>
            <span class="spacer"></span>
            <button class="link-btn" onclick="openPlanModal()">Plan Mode</button>
            <button class="link-btn" onclick="showProgress()">Experience</button>
        </div>
    </div>

    <!-- Workers panel -->
    <div class="section-label">Workers</div>
    <div class="workers" id="workersPanel"></div>

    <!-- Status bar -->
    <div class="status-bar">
        <span><b id="statRunning">0</b> running</span>
        <span><b id="statQueued">0</b> queued</span>
        <span><b id="statDone">0</b> done</span>
        <span><b id="statFailed">0</b> failed</span>
    </div>

    <!-- Task tabs + list -->
    <div class="tabs">
        <div class="tab active" data-tab="all" onclick="switchTab('all')">All <span class="badge" id="badgeAll">0</span></div>
        <div class="tab" data-tab="running" onclick="switchTab('running')">Running</div>
        <div class="tab" data-tab="queued" onclick="switchTab('queued')">Queued</div>
        <div class="tab" data-tab="done" onclick="switchTab('done')">Done</div>
    </div>

    <div class="task-list" id="taskList">
        <div class="empty-state">No tasks yet. Type above to get started.</div>
    </div>

    <!-- Log panel (slides up when task selected) -->
    <div class="log-overlay" id="logOverlay" style="display:none" onclick="if(event.target===this)closeLog()">
        <div class="log-panel">
            <div class="log-header">
                <span>Task #<span id="logTaskId"></span> <span id="logStatus" class="tag"></span></span>
                <div>
                    <button class="btn-sm danger" id="logCancelBtn" onclick="cancelTask()">Cancel</button>
                    <button class="btn-sm" onclick="closeLog()">Close</button>
                </div>
            </div>
            <div class="log-content" id="logContent"></div>
        </div>
    </div>

    <!-- Plan Modal -->
    <div class="modal-overlay" id="planModal" onclick="if(event.target===this)closeModal('planModal')">
        <div class="modal">
            <!-- Phase 1: Goal input -->
            <div id="planGoalPhase">
                <h2>Plan Mode</h2>
                <p class="hint">Describe a high-level goal. Claude will discuss details with you before generating a plan.</p>
                <div class="input-row modal-input">
                    <textarea id="planGoal" rows="3" placeholder="e.g. Build user auth with JWT, login/register endpoints, and middleware"></textarea>
                    <button class="mic-btn" onclick="voiceInto('planGoal')">&#127908;</button>
                </div>
                <div class="modal-actions">
                    <button class="btn-sm" onclick="closeModal('planModal')">Cancel</button>
                    <button class="btn-sm primary" onclick="submitPlan()">开始</button>
                </div>
            </div>
            <!-- Phase 2: Discussion -->
            <div id="planDiscussPhase" style="display:none">
                <div id="discussMessages" class="discuss-messages"></div>
                <div id="discussInputRow" class="discuss-input-row" style="display:none">
                    <textarea id="discussInput" rows="1" placeholder="输入自定义回答..." oninput="autoGrow(this)"></textarea>
                    <button class="send-btn" onclick="sendDiscuss()">&#10148;</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Plan Detail Modal -->
    <div class="modal-overlay" id="planDetailModal" onclick="if(event.target===this)closePlanDetail()">
        <div class="modal plan-detail-modal">
            <div class="plan-detail-header">
                <span id="planDetailGoal" class="plan-detail-goal"></span>
                <span id="planDetailStatus"></span>
            </div>

            <!-- Section: Discussion -->
            <div class="plan-detail-section">
                <div class="plan-detail-section-title" onclick="toggleSection('planDetailDiscuss')">
                    <span>讨论记录</span><span class="section-toggle" id="toggleDiscuss">▾</span>
                </div>
                <div id="planDetailDiscuss" class="plan-detail-discuss"></div>
            </div>

            <!-- Section: Plan Steps -->
            <div class="plan-detail-section">
                <div class="plan-detail-section-title">计划步骤</div>
                <ol class="plan-steps" id="planSteps"></ol>
            </div>

            <!-- Section: Execution Log -->
            <div class="plan-detail-section" id="planDetailLogSection" style="display:none">
                <div class="plan-detail-section-title">执行日志</div>
                <div id="planDetailLog" class="plan-detail-log"></div>
            </div>

            <div class="modal-actions" id="planDetailActions"></div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal-overlay" id="progressModal" onclick="if(event.target===this)closeModal('progressModal')">
        <div class="modal">
            <h2>Experience Notes</h2>
            <p class="hint">Auto-collected lessons from completed tasks. Injected into future prompts.</p>
            <div id="progressList"></div>
            <div class="modal-actions">
                <button class="btn-sm" onclick="closeModal('progressModal')">Close</button>
            </div>
        </div>
    </div>

    <script src="/static/app.js"></script>
</body>
</html>
